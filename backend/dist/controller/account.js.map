{"version":3,"sources":["../../src/controller/account.js"],"names":["TOKENTIME","SECRET","nodeMailer","require","config","db","api","post","req","res","UserDataExt","findUserByEmail","body","email","err","userData","status","json","message","Account","register","username","password","account","passport","authenticate","session","send","params","user","isactivated","save","next","scope","generateAccessToken","respond","console","log","async","waterfall","done","crypto","randomBytes","buf","token","toString","tokenExpiration","Date","now","passwordResetToken","smptTransport","createTransport","service","auth","XOAuth2","clienId","clientSecret","refreshToken","mailOptions","to","from","subject","text","sendMail","close","get","User","findOne","$gt","setPassword","undefined","error","success","pass"],"mappings":"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","file":"account.js","sourcesContent":["import mongoose from 'mongoose';\nimport { Router } from 'express';\nimport bodyParser from 'body-parser';\nimport passport from 'passport';\nimport config from '../config';\nimport Account from '../model/account';\nimport UserDataExt from './extensions/userData-ext';\nimport async from 'async';\nimport crypto from 'crypto';\nimport jwt from 'jsonwebtoken';\nimport expressJwt from 'express-jwt';\n\nimport { generateAccessToken, respond, authenticate } from '../middleware/authMiddleware';\n\nconst TOKENTIME = 60*60*24*90;\nconst SECRET = \"BadaGig SERVER SIDE\";\n\nvar  nodeMailer = require('nodemailer');\n\nexport default ({ config, db }) => {\n  let api = Router();\n\n  // '/v1/account/register'\n  api.post('/register', (req, res) => {\n    UserDataExt.findUserByEmail(req.body.email, (err, userData) => {\n      if (err) {\n        res.status(409).json({ message: `An error occured: ${err.message}`});\n        return;\n      } else if (userData) {\n        res.status(300).json({ message: `Email ${req.body.email} is already registered`});\n      }\n      // else {\n        Account.register(new Account({username: req.body.email}), req.body.password, function(err, account) {\n          if(err) {\n            res.status(500).json({ message: err });\n            return;\n          }\n          passport.authenticate('local', { session: false })(req, res, () => {\n              res.status(200).send('Successfully created new account');\n          });\n        });\n      // }\n    });\n  });\n  //'/v1/account/activateaccount/:email' This is to activate a newly created account via email\n  api.post('/activateaccount/:email', (req, res) => {\n    UserDataExt.findUserByEmail(req.params.email, (err, user) => {\n      if (err) {\n        res.status(500).json({message: `An error has occured, please try again. ${err.message}`});\n      } else if (!user) {\n        res.status(404).json({message: \"The specified email is not registered with us. Please proceed to create an account\"});\n      }\n        user.isactivated = true;\n        user.save(err => {\n          if (err) {\n              res.status(500).json({message: `An error has occured, please try again. ${err.message}`});\n          }\n            res.status(200).json(`You account have been successfully activiated. You can proceed to login`);\n        })\n    })\n  })\n\n  // '/v1/account/login'\n  api.post('/login', (req, res, next) => {\n\t\tUserDataExt.findUserByEmail(req.body.email, (err, userData) => {\n      if (err) {\n        res.status(409).json({ message: `An error occured: ${err.message}`});\n        return;\n      } else {\n\t\t\t\tnext();\n\t\t\t}\n    });\n\t}, passport.authenticate('local', { session: false, scope: [] }), (err, req, res, next) => {\n\t\tif (err) {\n\t\t\tres.status(401).json({ message: `Password is incorrect`});\n      return;\n\t\t}\n\t}, generateAccessToken, respond);\n\n  ///v1/account/forgot Generate token, token expiration and send email to user for instruction\n  api.post('/forgot', (req, res, next) => {\n    console.log('Trying to post');\n    async.waterfall([\n      (done) => {\n        crypto.randomBytes(4, (err, buf) => {\n          if (err) {\n            res.status(500).json({message: `An error occured: ${err.message}`});\n            return;\n          }\n            var token = buf.toString('hex');\n            done(err, token);\n        });\n      },\n        (token, done) => {\n          UserDataExt.findUserByEmail(req.body.email, (err, user) => {\n            console.log('Searching for user');\n            if (err) {\n              res.status(500).json({message: `An error occured: ${err.message}`});\n              return;\n            } else if (!user) {\n              res.status(404).json({message: `No user account found`});\n              return;\n            }\n            console.log('Assign token to user profile in mongodb');\n              user.tokenExpiration = Date.now() + 3600000 ;// one hour\n              user.passwordResetToken = token;\n            console.log('Saving token db');\n              user.save(err => {\n                if (err) {\n                  res.status(500).json({message: err});\n                  return;\n                }\n                done(err, user, token);\n              });\n          });\n        },\n\n      (err, user, token) => {\n        console.log('Tyring to login');\n        var smptTransport = nodeMailer.createTransport({\n          service: 'Gmail',\n          auth: {\n              XOAuth2: {\n                user: 'perfect.aduh@gmail.com',\n                clienId: '322793033087-q13jmff94tnv4gtqejqjio982kuoctfd.apps.googleusercontent.com',\n                clientSecret: 'YaSj9Bk2Og4nZlMlH8Twu_UB',\n                refreshToken: '1/iITHN8FnaWEZeMfPVrHxPojZ4AtCG22YLflgBxWm2W0'\n              }\n            }\n        });\n        var mailOptions = {\n          to: user.email,\n          from: 'noreply@badagig.ng',\n          subject: 'BadaGig Platform Password Reset Request',\n          text: 'Hello!' + '\\n' +\n            'You recently requested to reset your password for the BadaGig platform.' + '\\n' +\n            'Here is your reset code below.' + '\\n\\n' +\n                      token + '\\n\\n' +\n            'Copy the code above and use it to reset your password.' + '\\n\\n' +\n            'This code will only be valid for the next hour.' + '\\n' +\n            'If you did not request a password reset then please ignore this email.' + '\\n' +\n            'Thanks,' + '\\n' +\n            'Team BadaGig'\n        };\n          smptTransport.sendMail(mailOptions, (err) => {\n            console.log('Now sending mail');\n            if (err) {\n              console.log('Sendingmail failed');\n              res.status(500).json({message: `An error occured: ${err.message}`})\n              return;\n            }\n              //res.status(200).json({message: 'Password reset process has been iniated, please check your email'})\n              console.log('mail sent');\n              smptTransport.close();\n          });\n        }\n    ])\n  });\n\n  // /v1/account/reset/:token\n  api.get('/reset/:token', (req, res) => {\n    User.findOne({passwordResetToken: req.params.token, tokenExpiration: {$gt: Date.now()}}, (err, user) =>{\n      if (err) {\n        res.status(500).json({message: `An error occured: ${err.message}`});\n        return;\n      } else if (!user) {\n        res.status(404).json({message: 'Password reset token is invalid or has expired.' });\n        return;\n      }\n        res.status(200).json({message: 'Token found and valid'});\n    });\n  });\n\n  api.post('/reset/:token', (req, res) => {\n    async.waterfall([\n      (done) => {\n        User.findOne({passwordResetToken: req.params.token, tokenExpiration: {$gt: Date.now()}}, (err, user) =>{\n          if (err) {\n            res.status(500).json({message: `An error occured: ${err.message}`});\n            return;\n          } else if (!user) {\n            res.status(404).json({message: 'Password reset token is invalid or has expired.' });\n            return;\n          }\n          user.setPassword(req.body.password, (err) => {\n            user.passwordResetToken = undefined;\n            user.tokenExpiration = undefined;\n\n            user.save(err => {\n              if (err) {\n                res.status(500).json({error: 'Password reset failed, please try again'});\n                return;\n              }\n              res.status(200).json({success: 'Password has been reset successfully'});\n            });\n          });\n      });\n    },\n    (user, done) => {\n      var smptTransport = nodeMailer.createTransport({\n        service: 'Gmail',\n        auth: {\n          user: 'perfect.aduh@gmail.com',\n          pass: 'mmmmmmm'\n        }\n      });\n      var mailOptions = {\n        to: user.email,\n        from: `noreply@badagig.ng`,\n        subject: `BadaGig Platform Password Reset Request`,\n        text: `Hello!` + '\\n' +\n          'This is a confirmation that the password for your account user.email has been successfully updated' + '\\n' +\n          'Thanks,' + '\\n' +\n          'Team BadaGig'\n      };\n        smptTransport.sendMail(mailOptions, (err) => {\n          if (err) {\n            res.status(500).json({error: `An error occured: ${err.message}`})\n            return;\n          }\n            res.status(200).json({message: 'Password confirmation mail has been sent successfully'});\n          console.log('mail sent');\n        });\n      }\n    ])\n  });\n  return api;\n}\n"]}